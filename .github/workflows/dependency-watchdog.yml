name: Update Python Compatibility

on:
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:

jobs:
  update-python-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Get available stable Python versions
        id: python-versions
        run: |
          # Query available Python versions and filter for stable 3.12+ only
          VERSIONS=$(python3 -c "
          import json, urllib.request
          url = 'https://raw.githubusercontent.com/actions/python-versions/main/versions-manifest.json'
          data = json.loads(urllib.request.urlopen(url).read())
          versions = [v['version'] for v in data
                    if v.get('stable', False) == True
                    and float(v['version'].split('.')[0] + '.' + v['version'].split('.')[1]) >= 3.12]
          unique_versions = sorted(set(['.'.join(v.split('.')[:2]) for v in versions]),
                                  key=lambda x: [int(part) for part in x.split('.')])
          maturin_args = ' '.join(['-i python' + v for v in unique_versions])
          print(maturin_args)
          ")
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

      - name: Update build workflow
        run: |
          # Update the build workflow with new Python versions
          VERSIONS="${{ steps.python-versions.outputs.versions }}"
          sed -i -E 's/(args: --release --sdist) -i [^-]*(--features)/\1 '"$VERSIONS"' \2/' .github/workflows/build.yml
          echo "Updated build.yml content:"
          cat .github/workflows/build.yml

      - name: Create PR if changes
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "Update Python version support"
          title: "Update supported Python versions (3.12+)"
          body: "Automatically updated supported Python versions to include only stable 3.12+ releases."
          branch: update-python-versions
          delete-branch: true
