name: Update Python Compatibility

on:
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:

jobs:
  update-python-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Get available stable Python versions
        id: python-versions
        run: |
          # Query available Python versions and filter for stable 3.12+ only
          VERSIONS=$(python3 -c "
          import json, urllib.request
          url = 'https://raw.githubusercontent.com/actions/python-versions/main/versions-manifest.json'
          data = json.loads(urllib.request.urlopen(url).read())
          # Only include stable versions 3.12 and higher
          versions = [v['version'] for v in data
                    if v.get('stable', False) == True
                    and float(v['version'].split('.')[0] + '.' + v['version'].split('.')[1]) >= 3.12]
          maturin_args = ' '.join(['-i python' + '.'.join(v.split('.')[:2]) for v in versions])
          print(maturin_args)
          ")
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

      - name: Update build workflow
        run: |
          # Update the build workflow with new Python versions
          VERSIONS="${{ steps.python-versions.outputs.versions }}"
          sed -i "s/args: --release --sdist -i .* --features/args: --release --sdist $VERSIONS --features/" .github/workflows/build.yml

      - name: Create PR if changes
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "Update Python version support"
          title: "Update supported Python versions (3.12+)"
          body: "Automatically updated supported Python versions to include only stable 3.12+ releases."
          branch: update-python-versions
          delete-branch: true
